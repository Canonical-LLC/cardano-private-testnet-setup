# Use scripts to start network and connect db-sync

- Now, we get to the fun part.  We are ready to create & start a private Cardano network,
which will run three block producer nodes. Then, we connect the db-sync process to it, so that
activity occurring on the network gets stored in a SQL database.   
- As mentioned in the [project readme](./README.md), the scripts to create the private 
  Cardano network are taken from the `cardano-node` project and have been modified as needed.
  - Please find original script files in the IOHK git repository: [cardano-node/scripts](https://github.com/input-output-hk/cardano-node/tree/master/scripts)
---

## Clone this project

  ```shell
  # navigate to working directory, e.g. $HOME/src directory
  cd $HOME/src
  git clone https://github.com/woofpool/cardano-dbsync-private-network  
  ```

## Make the network files and start the network

**Note**: The remaining instructions below require opening several terminal windows/tabs.  You might prefer creating a `tmux` session 
and create window panes in your session to make it easier to see everything in the same terminal window.

- Adjust the [config.cfg file](./scripts/config.cfg) as desired. By default, the ROOT directory is set to `private-network`
- In **terminal #1**, run the `mkfiles` script to set up the network files
  ```shell
  # navigate to project root folder
  cd $HOME/src/cardano-dbsync-private-network
  
  # for convenience, lets export environment variable to store the name of the ROOT property set in the scripts/config.cfg
  export ROOT=private-network  # change value as necessary
  
  # run script file (note: it's important to run scripts from the root of the project as script paths are relative to the root)
  ./scripts/mkfiles.sh
  
  # output
  # verify the script completed successfully and the files were created in the $ROOT directory
  ```
- In the same **terminal #1**, start up the all three nodes using the script that gets generated by running make-network-files
  ```shell    
  # run generated script to start all three nodes
  ./$ROOT/run/all.sh
  
  # output
  # verify the output does not show any errors
  # It's possible you will see some forge errors, but they may go away, once all the nodes have connected to one another   
  ```

## Apply updates to the network to advance the network protocol to latest era and protocol version

At the time of this writing, the current era is `alonzo` and protocol version `6`. 
We will run update scripts one by one to advance the network to the current era/protocol version.

- Open **terminal #2** and run the `update-1` script
  ```shell
  # navigate to project root folder
  cd $HOME/src/cardano-dbsync-private-network
  
  # run script file
  ./scripts/update-1.sh
  
  # output
  # verify the script completed successfully 
  ```
- In **terminal #2**, wait for 1 to 2 epochs to make sure the update to protocol V1 is completed.
  ```shell
  # run query to find out the current epoch
  cardano-cli query tip --testnet-magic 42
  
  # run query to get network protocol info
  cardano-cli query protocol-parameters --testnet-magic 42
  ```
- In **terminal 2**, run the `update-2` script  
  ```shell
  # run script file
  ./scripts/update-2.sh
    
  # output
  # verify the script completed successfully 
  ```
- Switch to **terminal 1** and restart the nodes
  ```shell
  # Use Ctrl + c to stop the script process
  
  # run the script again to start up the nodes
  ./$ROOT/run/all.sh
  
  # output
  # verify the output does not show any errors
  # It's possible you will see some forge errors, but they may go away, once all the nodes have connected to one another   
  ```
- In **terminal 2**, wait for 1 to 2 epochs to make sure the update to protocol V2 is completed.
  ```shell
  # run query to find out the current epoch
  cardano-cli query tip --testnet-magic 42
  
  # run query to get network protocol info
  cardano-cli query protocol-parameters --testnet-magic 42
  ```
- In **terminal 2**, run the v3 update script
  ```shell
  # run script file and pass the current epoch number
  ./scripts/update-2.sh <current_epoch>
    
  # output
  # verify the script completed successfully 
  ```
- Switch to **terminal 1** and restart the nodes
  ```shell
  # Use Ctrl + c to stop the script process
  
  # run the script again to start up the nodes
  ./$ROOT/run/all.sh
  
  # output
  # verify the output does not show any errors
  # It's possible you will see some forge errors, but they may go away, once all the nodes have connected to one another   
  ```
- In **terminal 2**, wait for 1 to 2 epochs to make sure the update to protocol V3 is completed.
  ```shell
  # run query to find out the current epoch
  cardano-cli query tip --testnet-magic 42
  
  # run query to get network protocol info
  cardano-cli query protocol-parameters --testnet-magic 42
  ```
- Repeat the same process as you did for `update-3` for each of `update-4`, `update-5`, and `update-6`
to advance the protocol updates to Alonzo era and protocol V6. These are the current era and protocol
at the time of this writing.

## Connect the db-sync process to your private network

- In **terminal 3**, start db sync process
  ```shell
  # navigate to project root folder
  cd $HOME/src/cardano-dbsync-private-network
  
  # run script file
  ./scripts/db-sync-start.sh
  
  # output
  # verify the output does not show any errors   
  ```

## Create a transaction and query the database
  
  
  
