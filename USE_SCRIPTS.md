# Use scripts to start network and connect db-sync

---

**Now, we get to the fun part!**  We are ready to create & start a private Cardano network,
which will run three block producer nodes. Then, we set up a database for cardano-db-sync and connect the db-sync process to one of the cardano nodes, so that
it can synchronize to the activity occurring on the network and write data to its database.

As mentioned in the [project readme](./README.md), the scripts to create the private 
  Cardano network are from the `cardano-node` project and have been modified as needed.
  - Please find original script files in the IOHK git repository: [cardano-node/scripts](https://github.com/input-output-hk/cardano-node/tree/master/scripts)

**Note**: The instructions below require opening several terminal windows/tabs.  You might prefer creating a `tmux` session
and create window panes in your session to make it easier to see everything in the same terminal window.

## 1. Clone this project

  ```shell
  # navigate to working source directory
  cd $HOME/src
  git clone https://github.com/woofpool/cardano-dbsync-private-network  
  ```

## 2. Make the network files and start the network

- Adjust the [config.cfg file](./scripts/config.cfg) as desired. By default, the ROOT directory is set to `private-network`
- In **terminal #1**, run the `mkfiles` script to set up the network files
  ```shell
  # navigate to project root folder
  cd $HOME/src/cardano-dbsync-private-network
  
  # for convenience, lets export environment variable to store the name of the ROOT property set in the scripts/config.cfg
  export ROOT=private-network  # change value as necessary
  
  # run script file (note: it's important to run scripts from the root of the project as script paths are relative to the root)
  ./scripts/mkfiles.sh
  
  # output
  # verify the script completed successfully and the files were created in the $ROOT directory
  ```
- In the same **terminal #1**, start up the all three nodes using the script that gets generated by running make-network-files
  ```shell    
  # run generated script to start all three nodes
  ./$ROOT/run/all.sh
  
  # output
  # verify the output does not show any errors
  # It's possible you will see some forge errors, but they may go away, once all the nodes have connected to one another   
  ```

## 3. Apply updates to the network to advance the network protocol to latest era and protocol version

At the time of this writing, the current era is `alonzo` and protocol version `6`. 
We will run update scripts one by one to advance the network to the current era/protocol version.

- Open **terminal #2** and run the `update-1` script
  ```shell
  # navigate to project root folder
  cd $HOME/src/cardano-dbsync-private-network
  
  # run script file
  ./scripts/update-1.sh
  
  # output
  # verify the script completed successfully 
  ```
- In **terminal #2**, wait for 1 to 2 epochs to make sure the update to protocol V1 is completed.
  ```shell
  # run query to find out the current epoch
  cardano-cli query tip --testnet-magic 42
  
  # run query to get network protocol info
  cardano-cli query protocol-parameters --testnet-magic 42
  ```
- In **terminal 2**, run the `update-2` script  
  ```shell
  # run script file
  ./scripts/update-2.sh
    
  # output
  # verify the script completed successfully 
  ```
- Switch to **terminal 1** and restart the nodes
  ```shell
  # Use Ctrl + c to stop the script process
  
  # run the script again to start up the nodes
  ./$ROOT/run/all.sh
  
  # output
  # verify the output does not show any errors
  # It's possible you will see some forge errors, but they may go away, once all the nodes have connected to one another   
  ```
- In **terminal 2**, wait for 1 to 2 epochs to make sure the update to protocol V2 is completed.
  ```shell
  # run query to find out the current epoch
  cardano-cli query tip --testnet-magic 42
  
  # run query to get network protocol info
  cardano-cli query protocol-parameters --testnet-magic 42
  ```
- In **terminal 2**, run the v3 update script
  ```shell
  # run script file and pass the current epoch number
  ./scripts/update-2.sh <current_epoch>
    
  # output
  # verify the script completed successfully 
  ```
- Switch to **terminal 1** and restart the nodes
  ```shell
  # Use Ctrl + c to stop the script process
  
  # run the script again to start up the nodes
  ./$ROOT/run/all.sh
  
  # output
  # verify the output does not show any errors
  # It's possible you will see some forge errors, but they may go away, once all the nodes have connected to one another   
  ```
- In **terminal 2**, wait for 1 to 2 epochs to make sure the update to protocol V3 is completed.
  ```shell
  # run query to find out the current epoch
  cardano-cli query tip --testnet-magic 42
  
  # run query to get network protocol info
  cardano-cli query protocol-parameters --testnet-magic 42
  ```
- Repeat the same process as you did for `update-3` for each of `update-4`, `update-5`, and `update-6`
to advance the protocol updates to Alonzo era and protocol V6. These are the current era and protocol
at the time of this writing.

## 4. Create the db-sync database

- Modify the postgres connection file [here](postgres-conn/pgpass-privatenet) as necessary. The defaults should probably work for you.
- Open terminal and set up environment variable with path to the postgres connection file above
  ```shell
  export PGPASSFILE=$HOME/src/cardano-dbsync-private-network/postgres-conn/pgpass-privatenet
  
  # run the cardano-db-sync setup script to create database
  $HOME/src/cardano-db-sync/scripts/postgresql-setup.sh --createdb
  
  # output
  # verify you see "All good!" or correct any errors as necessary
  ```
- **Note**: Installing the schema for the database we just created will be done automatically, when we run the cardano-db-sync process

## 5. Connect the db-sync process to your private network

The schema migration scripts in the cardano-db-sync process will run automatically.

- In **terminal 3**, start db sync process
  ```shell
  # navigate to project root folder
  cd $HOME/src/cardano-dbsync-private-network
  
  # run script file
  ./scripts/db-sync-start.sh
  
  # output
  # verify the output does not show any errors   
  ```

## 6. Create a transaction and query the database
  
  
