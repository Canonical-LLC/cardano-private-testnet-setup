# Run scripts to start private testnet and connect db-sync to it

**Now, we get to the fun part!**  We are ready to create & start a private Cardano testnet.
The testnet will run three block producer nodes. 
After starting the testnet and running all protocol updates, we set up a PostgreSQL database for cardano-db-sync.
Then, we connect the db-sync process to one of the cardano nodes, so that
it can synchronize to the activity occurring on our testnet and write data to its database.

**Tip**: The instructions below require opening several terminal- windows or tabs.  You might prefer creating a [`tmux`](https://en.wikipedia.org/wiki/Tmux) session
and create several window panes in your session to make it easier to see everything in the same terminal window.

#### Assumptions
- This guide assumes you are running a recent version of linux.
  Specifically, these directions apply to Ubuntu (Debian). If you are using a different linux variant, please adjust as needed
- Before using this guide, you should have completed the [Install executables guide](./1-INSTALL_EXECUTABLES.md) and
  [Install PostgreSQL guide](2-INSTALL_POSTGRESQL.md).
  
## 1. Clone this project

  ```shell
  # navigate to working source directory
  cd ~/src
  git clone https://github.com/woofpool/cardano-private-testnet-setup
  ```

## 2. Make the network files and start the network

- Adjust the [config.cfg file](./scripts/config.cfg) as desired. By default, the ROOT directory is set to `private-network`
- In **terminal #1**, run the `mkfiles` script to set up the network files
  ```shell
  # navigate to project root folder
  cd ~/src/cardano-private-testnet-setup
  
  # run script file (note: it's important to run scripts from the root of the project as script paths are relative to the root)
  ./scripts/mkfiles.sh
  
  # inspect script output
  # If you see "Default yaml configuration applied." at the bottom, it was successful.
  ```
- In the same **terminal #1**, start up the all three nodes using the script that gets generated by running make-network-files
  ```shell
  # for convenience, lets create a variable to store the name of the directory for our private testnet
  # this directory was generated by running `./scripts/mkfiles.sh` above
  ROOT=private-testnet
    
  # run script to start all three nodes.
  ./$ROOT/run/all.sh
  
  # The output may show some Forge errors, but should go away once all the nodes are
  # synched to each other  
  ```

## 3. Apply updates to the network to advance the network protocol to latest era and protocol version

At the time of this writing, the current era is `alonzo` and protocol version `6`. 
We will run update scripts one by one to advance the network to the `alonzo` era/protocol version `6`.

Because we need to wait for epochs to advance after running protocol updates, it will take 20-30 minutes to run all the update scripts. 
**The good thing** is that if you don't delete your `private-testnet` folder containing the blockchain data, 
you can restart the nodes whenever you like, and your private testnet will be running in the current era and protocol.

- Open **terminal #2** and run the `update-1` script
  ```shell
  # navigate to project root folder
  cd ~/src/cardano-private-testnet-setup

  # set variables
  ROOT=private-testnet
  export CARDANO_NODE_SOCKET_PATH=$ROOT/node-bft1/node.sock
  
  # run script file
  ./scripts/update-1.sh
  
  # if you see an error about `<socket> does not exist`, wait a little longer and try submitting the `scripts/update-1.sh` script again
  ```
- In the same **terminal #2**, wait for at least the next epoch to make sure the update to protocol V1 is completed.
  ```shell
  
  # run query to find out the current epoch
  cardano-cli query tip --testnet-magic 42
  
  # the query should return something like this 
  {
    "epoch": 2,
    "hash": "587799cb34f2c68a04c29204e120418351f4b449aa5286c9b4ac3244f30a7933",
    "slot": 200,
    "block": 197,
    "era": "Byron",
    "syncProgress": "100.00"
  }    
  ```
- In **terminal 2**, run the `update-2` script  
  ```shell
  ./scripts/update-2.sh
  
  # verify the transactions submitted successfully
  # If you run the update script too early, you will see error regarding update proposal
  # Just continue waiting until the next epoch is reached and try running the update again
  ```
- Switch to **terminal 1** and restart the nodes
  ```shell
  # stop the script process
  ctrl+c, ctrl+c  
  # and run the script again to start up the nodes
  ./$ROOT/run/all.sh  
  ```
- In **terminal 2**, wait for a new epoch to make sure the update to protocol V2 is completed.
  ```shell
  # run query to find out the current epoch
  cardano-cli query tip --testnet-magic 42
  
  # you should see something like this
  {
    "epoch": 3,
    "hash": "d485e25f1287572ae75dbd35727ecd792595d88b66ac6e2144cbdf6dd1dab200",
    "slot": 302,
    "block": 290,
    "era": "Byron",
    "syncProgress": "100.00"
  }
  ```
- In **terminal 2**, run the v3 update script
  ```shell  
  ./scripts/update-3.sh <current_epoch>
  
  # verify the script update ran successfully
  # if you see something like the following, it means you need to wait for another epoch
  Command failed: transaction submit  Error: Error while submitting tx: ShelleyTxValidationError ShelleyBasedEraShelley (ApplyTxError [UtxowFailure (UtxoFailure (UpdateFailure (PPUpdateWrongEpoch (EpochNo 3) (EpochNo 3) VoteForNextEpoch)))])    
  ```
- Switch to **terminal 1** and restart the nodes
  ```shell
  # stop the script process
  ctrl+c, ctrl+c
  
  # run the script again to start up the nodes
  ./$ROOT/run/all.sh  
  ```
- In **terminal 2**, wait for at least the next epoch to make sure the update to protocol V3 is completed.
  ```shell
  # run query to find out the current epoch
  cardano-cli query tip --testnet-magic 42
  
  # Starting in the Shelley era, we can also run query to get network protocol info
  cardano-cli query protocol-parameters --testnet-magic 42
  ```
- Repeat the same process as you did for `update-3` for each of `update-4`, `update-5`, and `update-6`
to advance the protocol updates to Alonzo era and protocol V6. These are the current era and protocol
at the time of this writing.
- After completing the full set of updates, verify the era, major protocol version, and utxo balances of user1 address
  ```shell
  cardano-cli query tip --testnet-magic 42 | jq '.era'
  #output
  "Alonzo"
  
  cardano-cli query protocol-parameters --testnet-magic 42 | jq '.protocolVersion.major'
  #output
  6
  
  cardano-cli query utxo --address $(cat private-testnet/addresses/user1.addr) --testnet-magic 42
  #output
                            TxHash                                 TxIx        Amount
  --------------------------------------------------------------------------------------
  b0f91ee59eb208284467b1dec0adfa8c57eb1cf7587fb7eb0599e2b8c8e885c9     0        500000000 lovelace + TxOutDatumHashNone
  b0f91ee59eb208284467b1dec0adfa8c57eb1cf7587fb7eb0599e2b8c8e885c9     1        500000000 lovelace + TxOutDatumHashNone
  ``` 
- **Troubleshooting**: If you run `cardano-cli query tip` and the blocks are not advancing or the syncProgress is not at 100%,
  it may mean the processes running the nodes are running into garbage collection/memory issues.  The author is still researching
  the cause of this issue.  In any event, the best remedy is killing the run node processes, deleting the `private-testnet` folder
  and starting over.  This garbage collection issue normally happens early in the update process.
    - If you use Ctrl+c in the window running the `run/all.sh` script, it should kill the processes that started in the background.
      Another approach is to kill the processes directly by doing:
      ```shell
      # heavy-handed way of killing node processes
      
      # list the processes
      ps -eaf | grep cardano-node | grep -v grep
      
      # kill each of the process IDs that were found
      kill -9 <process_id>
      ```

## 4. Create the database for cardano-db-sync

This section assumes you have already installed the postgreSQL packages and created a postgres user/role for your linux account.
If not, please follow the [Install PostgreSQL instructions](./2-INSTALL_POSTGRESQL.md).

- You may modify the postgres connection file [here](postgres-conn/pgpass-privatenet) if desired.
    - Background info on [PostgreSQL docs on pgpass file](https://www.postgresql.org/docs/12/libpq-pgpass.html)
        - The format of the pgpass file String is `host:port:database:user:password` 
        - the host `/var/run/postgresql` refers to a socket directory, but can also be a standard DNS hostname
        - the database name is `privatenet`
        - the user and password are set to `*`, since we are using a unix account role to access the database
- Open terminal and set up environment variable with path to the postgres connection file above
  ```shell
  # change permissions on postgres connection file to prevent warning message
  chmod 600 ~/src/cardano-private-testnet-setup/postgres-conn/pgpass-privatenet
  
  export PGPASSFILE=~/src/cardano-private-testnet-setup/postgres-conn/pgpass-privatenet
  ```
- In the same terminal, we will run script in the `cardano-db-sync` project to manage the PostgreSQL database.
  The project sources for `cardano-db-sync` should already be on your machine, since you installed the executables. 
  ```shell
  # run the script to create the database
  ~/src/cardano-db-sync/scripts/postgresql-setup.sh --createdb    
  
  # sample output - ignore error shown below, when you are creating the database for the first time  
  # psql: error: FATAL:  database "privatenet" does not exist
  # All good! 
  
  # as an added validation, you can run --check, which includes a check for existence of database 
  ~/src/cardano-db-sync/scripts/postgresql-setup.sh --check
  
  # sample output
  Did not find any relations.
  All good!
  
  # TROUBLESHOOTING: if you run into issues, you can also drop the database, so that you can re-run create database
  ~/src/cardano-db-sync/scripts/postgresql-setup.sh --dropdb 
  ```

## 5. Connect the db-sync process to your private network

- Make sure the nodes are running
- If necessary, please modify the `SCHEMA_DIR` environment variable below based on the location of your cloned copy of cardano-db-sync project
- In **terminal 3**, start the db sync process.  This will install the database schema and sync blockchain data to the Postgres database.
  ```shell
  # navigate to project root folder
  cd ~/src/cardano-private-testnet-setup
  
  # set environment variable needed by `./scripts/db-sync-start.sh`
  export SCHEMA_DIR=~/src/cardano-db-sync/schema
  
  # run script file
  ./scripts/db-sync-start.sh
  
  # output
  # verify the output does not show any errors
  # in a steady state, you should see logs of SQL insert statements into slot_leader and block tables   
  ```

---

Continue to next guide: [4. Run transaction](./4-RUN_TRANSACTION.md)