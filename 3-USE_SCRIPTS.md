# Use scripts to start network and connect db-sync

**Now, we get to the fun part!**  We are ready to create & start a private Cardano network,
which will run three block producer nodes. Then, we set up a database for cardano-db-sync and connect the db-sync process to one of the cardano nodes, so that
it can synchronize to the activity occurring on the network and write data to its database.

**Tip**: The instructions below require opening several terminal windows/tabs.  You might prefer creating a `tmux` session
and create window panes in your session to make it easier to see everything in the same terminal window.

#### Assumptions
- This guide assumes you are running a recent version of linux.
  Specifically, these directions apply to Ubuntu (Debian). If you are using a different linux variant, please adjust as needed
  
## 1. Clone this project

  ```shell
  # navigate to working source directory
  cd ~/src
  git clone https://github.com/woofpool/cardano-private-testnet-setup  
  ```

## 2. Make the network files and start the network

- Adjust the [config.cfg file](./scripts/config.cfg) as desired. By default, the ROOT directory is set to `private-network`
- In **terminal #1**, run the `mkfiles` script to set up the network files
  ```shell
  # navigate to project root folder
  cd ~/src/cardano-private-testnet-setup
  
  # for convenience, lets export environment variable to store the name of the ROOT property set in the scripts/config.cfg
  export ROOT=private-network  # change value as necessary
  
  # run script file (note: it's important to run scripts from the root of the project as script paths are relative to the root)
  ./scripts/mkfiles.sh
  
  # output
  # verify the script completed successfully and the files were created in the $ROOT directory
  ```
- In the same **terminal #1**, start up the all three nodes using the script that gets generated by running make-network-files
  ```shell    
  # run generated script to start all three nodes
  ./$ROOT/run/all.sh
  
  # The output may show some Forge errors, but should go away once all the nodes are
  # synched to each other  
  ```

## 3. Apply updates to the network to advance the network protocol to latest era and protocol version

At the time of this writing, the current era is `alonzo` and protocol version `6`. 
We will run update scripts one by one to advance the network to the `alonzo` era/protocol version `6`.

It will take 15+ minutes to run all the update scripts.  But, after you've run the updates once, you can stop and start the network
to resume things as long as you don't wipe out the network directory.

- Open **terminal #2** and run the `update-1` script
  ```shell
  # navigate to project root folder
  cd ~/src/cardano-private-testnet-setup
  
  # run script file
  ./scripts/update-1.sh  
  ```
- In **terminal #2**, wait for at least the next epoch to make sure the update to protocol V1 is completed.
  ```shell
  # set environment variables
  export ROOT=private-network
  export CARDANO_NODE_SOCKET_PATH=$ROOT/node-bft1/node.sock
  
  # run query to find out the current epoch
  cardano-cli query tip --testnet-magic 42
  
  # the query should return something like this 
  {
    "epoch": 2,
    "hash": "587799cb34f2c68a04c29204e120418351f4b449aa5286c9b4ac3244f30a7933",
    "slot": 200,
    "block": 197,
    "era": "Byron",
    "syncProgress": "100.00"
  }
  ```
- In **terminal 2**, run the `update-2` script  
  ```shell
  ./scripts/update-2.sh
  
  # verify the update script worked
  ```
- Switch to **terminal 1** and restart the nodes
  ```shell
  # Use ctrl+c to stop the script process  
  # and run the script again to start up the nodes
  ./$ROOT/run/all.sh  
  ```
- In **terminal 2**, wait for a new epoch to make sure the update to protocol V2 is completed.
  ```shell
  # run query to find out the current epoch
  cardano-cli query tip --testnet-magic 42
  
  # you should see something like this
  {
    "epoch": 3,
    "hash": "d485e25f1287572ae75dbd35727ecd792595d88b66ac6e2144cbdf6dd1dab200",
    "slot": 302,
    "block": 290,
    "era": "Byron",
    "syncProgress": "100.00"
  }
  ```
- In **terminal 2**, run the v3 update script
  ```shell  
  ./scripts/update-3.sh <current_epoch>
  
  # verify the script update ran successfully
  # if you see something like the following, it means you need to wait for another epoch
  Command failed: transaction submit  Error: Error while submitting tx: ShelleyTxValidationError ShelleyBasedEraShelley (ApplyTxError [UtxowFailure (UtxoFailure (UpdateFailure (PPUpdateWrongEpoch (EpochNo 3) (EpochNo 3) VoteForNextEpoch)))])    
  ```
- Switch to **terminal 1** and restart the nodes
  ```shell
  # Use ctrl+c to stop the script process
  
  # run the script again to start up the nodes
  ./$ROOT/run/all.sh  
  ```
- In **terminal 2**, wait for at least the next epoch to make sure the update to protocol V3 is completed.
  ```shell
  # run query to find out the current epoch
  cardano-cli query tip --testnet-magic 42
  
  # Starting in the Shelley era, we can also run query to get network protocol info
  cardano-cli query protocol-parameters --testnet-magic 42
  ```
- Repeat the same process as you did for `update-3` for each of `update-4`, `update-5`, and `update-6`
to advance the protocol updates to Alonzo era and protocol V6. These are the current era and protocol
at the time of this writing.

## 4. Create the database for cardano-db-sync

- You may modify the postgres connection file [here](postgres-conn/pgpass-privatenet) if desired.
    - View more info on [PostgreSQL docs on pgpass file](https://www.postgresql.org/docs/12/libpq-pgpass.html)
    - The format of the pgpass file String is `host:port:database:user:password` 
    - the host `/var/run/postgresql` refers to a socket directory, but can also be a standard DNS hostname
    - the database name is `privatenet`
    - the user and password are set to `*`, since we are using a unix account role
- Open terminal and set up environment variable with path to the postgres connection file above
  ```shell
  chmod 600 ~/src/cardano-private-testnet-setup/postgres-conn/pgpass-privatenet  # this prevents a warning
  export PGPASSFILE=~/src/cardano-private-testnet-setup/postgres-conn/pgpass-privatenet
  
  # run the cardano-db-sync setup script to create database
  ~/src/cardano-db-sync/scripts/postgresql-setup.sh --createdb
  
  # sample output - ignore error shown below, when you are creating the database for the first time  
  # psql: error: FATAL:  database "privatenet" does not exist
  # All good! 
  
  # as an added validation, you can run --check, which includes a check for existence of database 
  ~/src/cardano-db-sync/scripts/postgresql-setup.sh --check
  
  # sample output
  Did not find any relations.
  All good!
  ```

## 5. Connect the db-sync process to your private network

- Make sure the private network is running
- If necessary, please modify the `SCHEMA_DIR` environment variable below based on the location of your cloned copy of cardano-db-sync project
- In **terminal 3**, start the db sync process.  This will install the database schema and sync blockchain data to the Postgres database.
  ```shell
  # navigate to project root folder
  cd ~/src/cardano-private-testnet-setup
  
  # set environment variable needed by `./scripts/db-sync-start.sh`
  export SCHEMA_DIR=~/src/cardano-db-sync/schema
  
  # run script file
  ./scripts/db-sync-start.sh
  
  # output
  # verify the output does not show any errors
  # in a steady state, you should see logs of SQL insert statements into slot_leader and block tables   
  ```
  
  
